<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Topology - BASim</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script>
        // Apply saved theme immediately to prevent flash
        (function() {
            const theme = localStorage.getItem('basim-theme') || 'ocean';
            document.documentElement.setAttribute('data-theme', theme);
        })();
    </script>
    <style>
        .page-wrap {
            max-width: 1400px;
            margin: 0 auto;
            padding: 15px;
        }
        .back { color: var(--text-muted); text-decoration: none; font-size: 21px; }
        .back:hover { color: var(--primary); }
        .page-title { font-size: 23px; font-weight: normal; margin: 12px 0 5px; letter-spacing: 2px; text-transform: uppercase; color: var(--primary); }
        .subtitle { color: var(--text-muted); font-size: 20px; margin-bottom: 18px; }
        
        /* Riser Diagram Container */
        .riser-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .riser-diagram {
            flex: 1;
            min-width: 0;
        }
        
        .riser-legend {
            width: 280px;
            flex-shrink: 0;
        }
        
        @media (max-width: 900px) {
            .riser-container {
                flex-direction: column;
            }
            .riser-legend {
                width: 100%;
            }
        }
        
        /* Network Layers */
        .network-layer {
            background: var(--card-bg);
            border: 1px solid var(--border);
            margin-bottom: 12px;
            position: relative;
        }
        
        .layer-header {
            padding: 10px 14px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-light);
        }
        
        .layer-header h2 {
            font-size: 20px;
            font-weight: normal;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--primary);
        }
        
        .layer-type {
            font-size: 16px;
            padding: 2px 6px;
            border: 1px solid;
        }
        
        .layer-type.ip { border-color: #2196F3; color: #2196F3; border-style: dashed; }
        .layer-type.mstp { border-color: #2196F3; color: #2196F3; border-style: dotted; }
        .layer-type.sc { border-color: #2196F3; color: #2196F3; border-style: solid; }
        .layer-type.tcp { border-color: #4CAF50; color: #4CAF50; border-style: dashed; }
        .layer-type.rtu { border-color: #4CAF50; color: #4CAF50; border-style: dotted; }

        
        .layer-body {
            padding: 12px;
        }
        
        .layer-info {
            font-size: 18px;
            color: var(--text-muted);
            margin-bottom: 10px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .layer-info span {
            display: flex;
            gap: 4px;
        }
        
        .layer-info .lbl {
            color: var(--text-muted);
        }
        
        /* Device Grid */
        .device-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        /* Device Cards */
        .device-card {
            background: var(--bg);
            border: 1px solid var(--border);
            padding: 8px 10px;
            min-width: 180px;
            flex: 1 1 180px;
            max-width: 280px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .device-card:hover {
            border-color: var(--primary);
            background: var(--bg-light);
        }
        
        .device-card.expanded {
            flex-basis: 100%;
            max-width: none;
        }
        
        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 4px;
        }
        
        .device-id {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary);
        }
        
        .device-type-badge {
            font-size: 14px;
            padding: 1px 4px;
            border: 1px solid var(--border);
            color: var(--text-muted);
        }
        
        .device-name {
            font-size: 20px;
            color: var(--primary);
            font-weight: bold;
            margin-bottom: 2px;
        }
        
        .device-model {
            font-size: 16px;
            color: var(--text-muted);
        }
        
        .device-addr {
            font-size: 16px;
            color: var(--text);
            margin-top: 4px;
            padding-top: 4px;
            border-top: 1px solid var(--border);
        }
        
        .device-details {
            display: none;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border);
        }
        
        .device-card.expanded .device-details {
            display: block;
        }
        
        .detail-row {
            display: flex;
            font-size: 16px;
            padding: 2px 0;
        }
        
        .detail-row .lbl {
            width: 80px;
            color: var(--text-muted);
            flex-shrink: 0;
        }
        
        .detail-row .val {
            color: var(--text-dim);
        }
        
        .object-list {
            margin-top: 8px;
        }
        
        .object-list h4 {
            font-size: 16px;
            color: var(--text-muted);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .obj-item {
            font-size: 16px;
            padding: 2px 4px;
            background: var(--bg);
            margin-bottom: 2px;
            display: flex;
            gap: 8px;
        }
        
        .obj-ref {
            color: var(--primary);
            min-width: 50px;
        }
        
        .obj-name {
            color: var(--text-dim);
        }
        
        /* Connection Lines */
        .connection-line {
            position: absolute;
            left: 20px;
            bottom: -12px;
            width: 2px;
            height: 12px;
            background: var(--border);
        }
        
        /* Router/Gateway Device */
        .device-card.router, .device-card.gateway {
            border-width: 2px;
        }
        
        .device-card.bacnet.router, .device-card.bacnet.gateway {
            border-color: #2196F3;
        }
        
        .device-card.modbus.router, .device-card.modbus.gateway {
            border-color: #4CAF50;
        }
        
        /* Legend */
        .legend-box {
            background: var(--card-bg);
            border: 1px solid var(--border);
            padding: 12px;
        }
        
        .legend-box h3 {
            font-size: 20px;
            font-weight: normal;
            color: var(--primary);
            margin: 0 0 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
            font-size: 18px;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border: 1px solid;
        }
        
        .legend-color.ip { border-color: #2196F3; background: rgba(33, 150, 243, 0.1); border-style: dashed; }
        .legend-color.mstp { border-color: #2196F3; background: rgba(33, 150, 243, 0.1); border-style: dotted; }
        .legend-color.sc { border-color: #2196F3; background: rgba(33, 150, 243, 0.1); border-style: solid; }
        .legend-color.tcp { border-color: #4CAF50; background: rgba(76, 175, 80, 0.1); border-style: dashed; }
        .legend-color.rtu { border-color: #4CAF50; background: rgba(76, 175, 80, 0.1); border-style: dotted; }

        
        .legend-label {
            color: var(--text-dim);
        }
        
        .legend-desc {
            color: var(--text-muted);
            font-size: 16px;
            margin-left: auto;
        }
        

        
        /* Stats Summary */
        .stats-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .stat-box {
            background: var(--card-bg);
            border: 1px solid var(--border);
            padding: 10px 15px;
            text-align: center;
            min-width: 100px;
        }
        
        .stat-value {
            font-size: 33px;
            color: var(--primary);
        }
        
        .stat-label {
            font-size: 16px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Protocol Tabs */
        .proto-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
        }
        
        .proto-tabs button {
            padding: 8px 16px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-muted);
            font-size: 20px;
            cursor: pointer;
            font-family: inherit;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .proto-tabs button:hover {
            border-color: var(--primary);
            color: var(--text-dim);
        }
        
        .proto-tabs button.active {
            background: var(--primary);
            color: #000;
            border-color: var(--primary);
        }
        
        .proto-content {
            display: none;
        }
        
        .proto-content.active {
            display: block;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }
        
        /* Mobile */
        @media (max-width: 600px) {
            .page-wrap { padding: 10px; }
            h1 { font-size: 21px; }
            .device-card { min-width: 150px; flex-basis: 100%; max-width: none; }
            .stat-box { min-width: 80px; padding: 8px 10px; }
            .stat-value { font-size: 26px; }
            .proto-tabs { overflow-x: auto; -webkit-overflow-scrolling: touch; }
            .proto-tabs button { white-space: nowrap; padding: 6px 12px; font-size: 18px; }
        }
    </style>
</head>
<body>
    <div class="wip-banner" style="background-color: rgba(255, 152, 0, 0.5); color: #000; text-align: center; padding: 5px; font-weight: bold; font-family: sans-serif; font-size: 14px;">
        ⚠️ WORK IN PROGRESS: This simulator is under active development.
    </div>
    <div class="page-wrap">
        <header>
            <div class="header-top">
                <h1>BASim <span id="header-title" style="font-size: 0.5em; font-weight: normal; opacity: 0.7; margin-left: 15px;">- [Main Campus]</span></h1>
                <div class="user-info">
                    <a href="{{ url_for('readme_page') }}" class="admin-link" style="margin-right: 15px; text-decoration: none; color: var(--text-muted);">[DOC] Readme</a>
                    <a href="{{ url_for('topology_page') }}" class="admin-link" style="margin-right: 15px; text-decoration: none; color: var(--text-muted);">[NET] Topology</a>
                    <a href="{{ url_for('protocols_page') }}" class="admin-link" style="margin-right: 15px; text-decoration: none; color: var(--text-muted);">[INT] Protocols</a>
                    {% if user.role == 'admin' %}
                    <a href="{{ url_for('admin_config') }}" class="admin-link" style="margin-right: 15px; text-decoration: none; color: var(--text-muted);">[CFG] Admin</a>
                    {% endif %}
                    <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
                </div>
            </div>
        </header>
        <a href="{{ url_for('index') }}" class="back" style="display: inline-block; margin-top: 15px;">[&lt;] Dashboard</a>
        <h1 class="page-title">Network Topology</h1>
        <p class="subtitle">Network riser diagram showing all simulated BAS devices and communication paths</p>
        
        <div id="main">
            <div class="loading">Loading topology...</div>
        </div>
    </div>
    
    <script>
        let topologyData = null;
        
        async function init() {
            try {
                const r = await fetch('/api/protocols');
                if (!r.ok) throw new Error('Load failed');
                topologyData = await r.json();
                render();
            } catch (e) {
                document.getElementById('main').innerHTML = '<p style="color:var(--danger);padding:20px;">Error loading topology data</p>';
            }
        }
        
        function toggleDevice(el) {
            el.classList.toggle('expanded');
        }
        
        function switchProtocol(proto) {
            document.querySelectorAll('.proto-tabs button').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.proto-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`.proto-tabs button[data-proto="${proto}"]`).classList.add('active');
            document.getElementById(`proto-${proto}`).classList.add('active');
        }
        
        function renderDevice(device, protocol) {
            const isRouter = device.device_type?.includes('Router') || device.device_type?.includes('Gateway');
            const isGateway = device.device_type?.includes('Gateway');
            
            let addrInfo = '';
            if (protocol === 'bacnet') {
                if (device.ip_address) addrInfo = `${device.ip_address}:${device.port}`;
                if (device.mstp_mac !== undefined) addrInfo += ` | MAC ${device.mstp_mac}`;
            } else {
                if (device.ip_address) addrInfo = `${device.ip_address}:${device.port}`;
                else if (device.serial_port) addrInfo = `${device.serial_port} @ ${device.baud_rate}`;
                addrInfo += ` | UID ${device.unit_id}`;
            }
            
            const objects = device.objects || device.registers || [];
            const objLabel = protocol === 'bacnet' ? 'BACnet Objects' : 'Modbus Registers';
            
            return `
                <div class="device-card ${protocol} ${isRouter ? 'router' : ''} ${isGateway ? 'gateway' : ''}" onclick="toggleDevice(this)">
                    <div class="device-header">
                        <span class="device-id">${protocol === 'bacnet' ? `DEV ${device.device_id}` : `UID ${device.unit_id}`}</span>
                        <span class="device-type-badge">${device.device_type}</span>
                    </div>
                    <div class="device-name">${device.device_name}</div>
                    <div class="device-model">${device.vendor} ${device.model}</div>
                    <div class="device-addr">${addrInfo}</div>
                    <div class="device-details">
                        <div class="detail-row"><span class="lbl">Description</span><span class="val">${device.description || '-'}</span></div>
                        ${device.routed_networks ? `<div class="detail-row"><span class="lbl">Routes To</span><span class="val">Networks ${device.routed_networks.join(', ')}</span></div>` : ''}
                        ${objects.length > 0 ? `
                            <div class="object-list">
                                <h4>${objLabel} (${objects.length})</h4>
                                ${objects.slice(0, 8).map(o => `
                                    <div class="obj-item">
                                        <span class="obj-ref">${o.type}:${o.instance || o.address}</span>
                                        <span class="obj-name">${o.name}</span>
                                    </div>
                                `).join('')}
                                ${objects.length > 8 ? `<div class="obj-item" style="color:var(--text-muted);">... and ${objects.length - 8} more</div>` : ''}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }
        
        function renderBACnetNetwork(network) {
            const devices = topologyData.bacnet.devices.filter(d => {
                if (network.network_type === 'BACnet/IP') {
                    return d.network_number === network.network_number && d.network_type?.includes('IP');
                } else if (network.network_type === 'BACnet/SC') {
                    return d.network_number === network.network_number;
                } else if (network.network_type === 'BACnet MS/TP') {
                    return d.mstp_network === network.network_number || d.network_number === network.network_number;
                }
                return d.network_number === network.network_number;
            });
            
            let typeClass = 'ip';
            if (network.network_type.includes('MS/TP')) typeClass = 'mstp';
            else if (network.network_type.includes('SC')) typeClass = 'sc';
            
            let netInfo = '';
            if (network.network_type === 'BACnet/IP') {
                netInfo = `<span><span class="lbl">BBMD:</span> ${network.bbmd}</span>`;
            } else if (network.network_type === 'BACnet MS/TP') {
                netInfo = `<span><span class="lbl">Baud:</span> ${network.baud_rate}</span>
                          <span><span class="lbl">Max Master:</span> ${network.max_master}</span>`;
            } else if (network.network_type === 'BACnet/SC') {
                netInfo = `<span><span class="lbl">Hub:</span> ${network.hub_uri}</span>`;
            }
            
            return `
                <div class="network-layer">
                    <div class="layer-header">
                        <h2>Network ${network.network_number}: ${network.description}</h2>
                        <span class="layer-type ${typeClass}">${network.network_type}</span>
                    </div>
                    <div class="layer-body">
                        <div class="layer-info">${netInfo}</div>
                        <div class="device-grid">
                            ${devices.map(d => renderDevice(d, 'bacnet')).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderModbusNetwork(network) {
            let devices;
            if (network.network_type === 'Modbus TCP') {
                devices = topologyData.modbus.devices.filter(d => d.network_type === 'Modbus TCP');
            } else {
                devices = topologyData.modbus.devices.filter(d => d.network_number === network.network_number);
            }
            
            let typeClass = network.network_type.includes('TCP') ? 'tcp' : 'rtu';
            
            let netInfo = '';
            if (network.network_type === 'Modbus TCP') {
                netInfo = `<span><span class="lbl">Port:</span> ${network.port || 5020}</span>`;
            } else {
                netInfo = `<span><span class="lbl">Port:</span> ${network.serial_port}</span>
                          <span><span class="lbl">Baud:</span> ${network.baud_rate}</span>
                          <span><span class="lbl">Format:</span> ${network.data_bits}${network.parity}${network.stop_bits}</span>`;
            }
            
            return `
                <div class="network-layer">
                    <div class="layer-header">
                        <h2>${network.network_type === 'Modbus TCP' ? 'TCP Gateway' : `RS-485 Network ${network.network_number}`}: ${network.description}</h2>
                        <span class="layer-type ${typeClass}">${network.network_type}</span>
                    </div>
                    <div class="layer-body">
                        <div class="layer-info">${netInfo}</div>
                        <div class="device-grid">
                            ${devices.map(d => renderDevice(d, 'modbus')).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        

        

        

        
        function render() {
            const bacnet = topologyData.bacnet;
            const modbus = topologyData.modbus;
            
            // Count stats
            const bacnetDevices = bacnet.devices.length;
            const modbusDevices = modbus.devices.length;
            const bacnetNetworks = bacnet.networks.length;
            const modbusNetworks = modbus.networks.length;
            const totalObjects = bacnet.devices.reduce((sum, d) => sum + (d.objects?.length || 0), 0);
            const totalRegisters = modbus.devices.reduce((sum, d) => sum + (d.registers?.length || 0), 0);
            
            document.getElementById('main').innerHTML = `
                <div class="stats-row">
                    <div class="stat-box">
                        <div class="stat-value">${bacnetDevices + modbusDevices}</div>
                        <div class="stat-label">Total Devices</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${bacnetNetworks + modbusNetworks + 1}</div>
                        <div class="stat-label">Networks</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${bacnetDevices}</div>
                        <div class="stat-label">BACnet Devices</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${modbusDevices}</div>
                        <div class="stat-label">Modbus Devices</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${totalObjects}</div>
                        <div class="stat-label">BACnet Objects</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${totalRegisters}</div>
                        <div class="stat-label">Modbus Registers</div>
                    </div>
                </div>
                
                <div class="proto-tabs">
                    <button class="active" data-proto="bacnet" onclick="switchProtocol('bacnet')">BACnet</button>
                    <button data-proto="modbus" onclick="switchProtocol('modbus')">Modbus</button>
                </div>
                
                <div class="riser-container">
                    <div class="riser-diagram">
                        <div id="proto-bacnet" class="proto-content active">
                            ${bacnet.networks.map(n => renderBACnetNetwork(n)).join('')}
                        </div>
                        
                        <div id="proto-modbus" class="proto-content">
                            ${modbus.networks.map(n => renderModbusNetwork(n)).join('')}
                        </div>
                    </div>
                    
                    <div class="riser-legend">
                        <div class="legend-box">
                            <h3>Network Types</h3>
                            <div class="legend-item">
                                <div class="legend-color ip"></div>
                                <span class="legend-label">BACnet/IP</span>
                                <span class="legend-desc">Ethernet</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color mstp"></div>
                                <span class="legend-label">BACnet MS/TP</span>
                                <span class="legend-desc">RS-485</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color sc"></div>
                                <span class="legend-label">BACnet/SC</span>
                                <span class="legend-desc">Secure Connect</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color tcp"></div>
                                <span class="legend-label">Modbus TCP</span>
                                <span class="legend-desc">Ethernet</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color rtu"></div>
                                <span class="legend-label">Modbus RTU</span>
                                <span class="legend-desc">RS-485</span>
                            </div>
                        </div>
                        
                        <div class="legend-box" style="margin-top: 12px;">
                            <h3>Device Types</h3>
                            <div class="legend-item">
                                <div class="legend-color" style="border-color: var(--primary); border-width: 2px;"></div>
                                <span class="legend-label">Router/Gateway</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="border-color: var(--border);"></div>
                                <span class="legend-label">Controller/Device</span>
                            </div>
                        </div>
                        
                        <div class="legend-box" style="margin-top: 12px;">
                            <h3>Interaction</h3>
                            <p style="font-size: 18px; color: var(--text-muted); margin: 0;">
                                Click any device card to expand and view detailed information including BACnet objects or Modbus registers.
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }
        
        init();
    </script>
</body>
</html>
